<chapter id="troubleshooting">
  <title>Troubleshooting</title>

  <para>
    This chapter provides some hints to common problems seen while
    installing or using &ps4;. Of course, more help will be provided by
    <email>support@cluster-competence-center.com</email>.
  </para>

  <section id="tr_wontstartup">
    <title>
      Problem: <command>psiadmin</command> returns error
    </title>
    <para>
      When starting up the &ps; admin command
      <command>psiadmin</command>, an error is reported:
    </para>
    <programlisting>
# psiadmin
PSC: PSC_startDaemon: connect() fails: Connection refused
    </programlisting>
    <para>
      Reason: the local &ps; daemon could not be contacted. Verify
      that the <xref linkend="psid"/> daemon is up and running. Check
      if the daemon is known to the (x)inetd:
    </para>
    <programlisting>
# netstat -at | grep psid
tcp        0      0 *:psid                  *:*      LISTEN
    </programlisting>
    <para>
      If no "listening" socket is reported, check
      <filename>/etc/services</filename> for an entry of the &ps;
      daemon:
    </para>
    <programlisting>
# grep psid /etc/services
psid             888/tcp       # ParaStation Daemon start port
    </programlisting>
    <para>
      In addition, verify that the daemon is configured within
      <filename>/etc/inetd.conf</filename>:
    </para>
    <programlisting>
# grep psid /etc/inetd.conf
psid    stream  tcp     nowait  root    /opt/parastation/bin/psid psid
    </programlisting>
    <para>
      or check for an entry
      <filename>/etc/xinetd/parastation</filename>, if
      <filename>xinetd</filename> is used.
    </para>
    <para>
      If this is ok, reload (x)inetd:
    </para>
    <programlisting>
# kill -HUP &lt;pid of inetd&gt;
    </programlisting>
    <para>
      If everything seems to be ok up to now, check for recent entries within
      <filename>/var/log/messages</filename>. Be aware, the log
      facility can be modified using the
      <parameter>LogDestination</parameter> within the
      config file <filename>parastation.conf</filename>. 
      Look for lines like
    </para>
    <programlisting>
Mar 24 17:19:12 pan psid[7361]: Starting ParaStation DAEMON
Mar 24 17:19:12 pan psid[7361]: Protocol Version 329
Mar 24 17:19:12 pan psid[7361]:  (c) ParTec AG (www.par-tec.com)
    </programlisting>
    <para>
      These lines indicate a normal startup of the psid. Other
      messages may indicate problems found by the psid, eg. errors
      within the configuration file.
    </para>
  </section>

  <section>
    <title>
      Problem: node shown as "down"
    </title>
    <para>
      Maybe the node is currently not available (shutdown or
      crashed), or the network connection to this node is not
      available.
    </para>
    <para>
      Try to <filename>ping</filename> this node. If ok, try to
      startup &ps;. From an other node, "add" these node:
    </para>
    <programlisting>psiadmin> add &lt;nodeid&gt;</programlisting>
    <para>
      Or logged on to this node, run <command>psiadmin</command>
      which also starts up the &ps; daemon <filename>psid</filename>.
      See <xref linkend="tr_wontstartup"/> for more details.
    </para>
    <para>
      Check the logfile <filename>/var/log/messages</filename> on
      this node for error messages. 
<!--
      Especially the message
    </para>
    <programlisting>psid[4457]: MCast: Getting MCast ping from unknown node [3 192.168.1.5(2)]</programlisting>
    <para>
      will point to a miss-configuration of node names within
      <filename>parastation.conf</filename>. Probably nodes using
      more then one network interface are affected. Verify, that
      only nodes "visible" from within the cluster are listed within
      the configuration file.
-->
      Verify that all nodes have an identical configuration
      (<filename>/etc/parastation.conf</filename>).
    </para>
  </section>

<!--
  <section>
    <title>
      Problem: After "adding" nodes, they are reported as "up", but
      after a short period of time, they are reported as "down":
    </title>
    <para>
      Look for "missing multicast license pings" messages 
    </para>
    <programlisting>  psid[7380]: MCast: Ping from LicServer 192.168.1.5 missing [11]</programlisting>
    <para>
      within the
      message file of the nodes. Probably, the license daemon
      running on the frontend node does not send license pings to
      the proper network interface. 
    </para>
    <para>
      Add a multicast route on the frontend to redirect multicast
      messages to the cluster:
    </para>
    <programlisting>	route add -net 224.0.0.0 netmask 240.0.0.0 dev <replaceable>ethX</replaceable></programlisting>
    <para>
      where <replaceable>ethX</replaceable> should be replaced by
      the actual name of the interface connecting to all other
      cluster nodes. In order to enable this route at system
      startup, a corresponding entry has to be added to
      <filename>/etc/route.conf</filename> or
      <filename>/etc/sysconfig/networks/routes</filename>, depending
      on the type of Linux distribution in use.
    </para>
  </section>
-->

  <section>
    <title>
      Problem: cannot start application
    </title>
    <para>
      Problem: application cannot be launched, an error is reported:
    </para>
    <programlisting>PSI: PSI_createPartition: Resource temporarily unavailable</programlisting>
    <para>
      Check for available nodes and active parallel tasks. Check for
      user or group restrictions.
    </para>
    <para>
<!--      MOD:  -->
      If the error
    </para>
    <programlisting>PSI: dospawn: spawn to node 1 failed.
PSE: Could not spawn './mpi_latency' process 1, error = Bad file descriptor.</programlisting>
    <para>
      is reported, 
      check if the current directory holding the program
      <command>mpi_latency</command> is accessible on all nodes.
      Verify that the program is executable on all nodes.
    </para>
  </section>

  <section>
    <title>
<!--      MOD:  -->
      Problem: bad performance
    </title>
    <para>
      Verify that the proper interconnect and/or transport is used:
      check for environment variables controlling transport (see
      <xref linkend="techdetails_compath"/> and
      <citerefentry>
        <refentrytitle>ps_environment</refentrytitle>
        <manvolnum>5</manvolnum> 
      </citerefentry>).
    </para>
    <para>
      Watch protocol counters, eg. counters indication timeouts,
      retries, errors or other bad conditions. For p4sock, check
      <filename>recv_net_data</filename> and
      <filename>recv_user</filename>. See <xref
      linkend="techdetails_p4sock"/>.
    </para>
    <para>
      Look for a crystal bowl! Or contact
      <email>support@cluster-competence-center.com</email>.
      <!-- fg: TODO. -->
    </para>
  </section>

  <section>
    <title>
      Problem: different groups of nodes are seen as up or down
    </title>
    <para>
      Problem: depending on which node the <command>psiadmin</command> is run,
      different groups of nodes are seen as "up" or "down".
    </para>
    <para>
      Check for identical configuration on each node, eg. compare
      the configuration file
      <filename>/etc/parastation.conf</filename> on each node.
    </para>
  </section>

  <section>
    <title>
      Warning issued on startup of applications
    </title>
    <para>
      While starting up a parallel task, the message
    </para>
    <programlisting>
execClient: chdir(/usr/tmp/username/./.): No such file or directory
Will use user's home directory
---------------------------------------
    </programlisting>
    <para>
      is displayed.
    </para>
    <para>
      The current working directory
      <filename>/usr/tmp/username</filename> does not exist on one
      or more of the remote nodes. The users home directory, defined
      by the environment variable <envar>HOME</envar> will be used
      instead.
    </para>
    <para>
      Make sure that the directory
      <filename>/usr/tmp/username</filename> is accessible on each
      node or change your current working directory to a globally
      accessible directory.
    </para>
  </section>
</chapter>
