###################################################### -*- Makefile -*- #####
#                  ParaStation
#        Copyright (c) 2002-2003 ParTec AG Karlsruhe
#        All rights reserved.
#############################################################################
#
# $Id: Makefile.in,v 1.11 2004/02/10 17:02:11 hauke Exp $
#
# @author
#         Jens Hauke <hauke@par-tec.de>
#         Norbert Eicker <eicker@par-tec.de>
#############################################################################

TOP_SRCDIR := @top_srcdir@
TOP_BUILDDIR := ..

TARGET_OS := @target_os@
TARGET_CPU := @target_cpu@

#s.o. clean:
BUILDDIR := build
DISTPATH := opt/parastation
DISTDIR := $(BUILDDIR)/$(DISTPATH)

INCLUDES += pshwtypes.h pse.h
INCDIR := $(DISTDIR)/include

BINS += psiadmin psid psilogger mlisten
BINS += psmstart mpirun_chp4 psispawn mpirun_chgm gmspawner test_pse
BINDIR := $(DISTDIR)/bin

LIBS += libpsi.a libpse.a
ifeq ("$(TARGET_OS)","linux")
LIBS += libpsi.so libpse.so
endif
LIBDIR := $(DISTDIR)/lib

SCRIPTS += ps_gmcounters
SCRIPTDIR := $(DISTDIR)/scripts

CONFIGDIR := $(DISTDIR)/config

MISC += config/parastation.conf.tmpl VERSION.psmgmt INSTALL config/PSM_INSTALL
MISC += config/ps_gm ChangeLog.psmgmt

MISCDIR :=

DIRS += $(BINDIR) $(LIBDIR) $(INCDIR) $(SCRIPTDIR) $(CONFIGDIR) $(MISCDIR)

######################################################
MISCEXP := $(patsubst %,$(DISTDIR)/%, $(MISC))

all: dirs libs bins includes scripts $(MISCEXP) tar rpm

dist:	all

# Creating directories
$(DIRS):
	mkdir -p $@

dirs: $(DIRS)

#
# building stripped libs
#
ifeq ("$(TARGET_OS)","linux")
$(LIBDIR)/%: $(TOP_BUILDDIR)/lib/%
	cp $< $@
	strip -g $@
endif
ifeq ("$(TARGET_OS)","osf5.1")
$(LIBDIR)/%: $(TOP_BUILDDIR)/lib/%
	cp $< $@
endif

libs: $(LIBDIR) $(patsubst %,$(LIBDIR)/%,$(LIBS))

#
# building stripped bins
#
$(BINDIR)/%: $(TOP_BUILDDIR)/bin/%
	cp $< $@
	strip $@
#	strip $< -o $@

bins: $(BINDIR) $(patsubst %,$(BINDIR)/%,$(BINS))

#
# copy includes
#
$(INCDIR)/%: $(TOP_SRCDIR)/include/%
	cp $< $@

includes: $(INCDIR) $(patsubst %,$(INCDIR)/%,$(INCLUDES))

#
# copy scripts
#
$(SCRIPTDIR)/%: $(TOP_SRCDIR)/scripts/%
	cp $< $@

scripts: $(SCRIPTDIR) $(patsubst %,$(SCRIPTDIR)/%,$(SCRIPTS))

#
# Misc files
#
$(DISTDIR)/config/parastation.conf.tmpl: $(TOP_SRCDIR)/doc/parastation.conf
	cp $< $@

$(DISTDIR)/INSTALL: $(TOP_SRCDIR)/doc/INSTALL
	cp $< $@

$(DISTDIR)/config/ps_gm: $(TOP_SRCDIR)/scripts/ps_gm
	cp $< $@

$(DISTDIR)/config/findmodule: $(TOP_SRCDIR)/scripts/findmodule
	cp $< $@

$(DISTDIR)/config/PSM_INSTALL: $(TOP_SRCDIR)/scripts/PSM_INSTALL@TRU64FILEADD@
	cp $< $@

# TRU64 file
$(DISTDIR)/config/sysconfigtab: $(TOP_SRCDIR)/kern/OSF1/sysconfigtab
	cp $< $@

# TRU64 file
$(DISTDIR)/config/psm_makedev: $(TOP_SRCDIR)/scripts/psm_makedev
	cp $< $@

.PHONY: $(DISTDIR)/VERSION.psmgmt
$(DISTDIR)/VERSION.psmgmt:
	echo "ParaStation Management $(DVER) ($(shell date))" > $@

$(DISTDIR)/ChangeLog.psmgmt: $(TOP_SRCDIR)/dist_mgmt/ChangeLog
	cp $< $@

######################################################
# Create tar file

ifeq ($(DVER),)
tar rpm:
	@echo Use DVER=x.x.x to create $@ file.
else

tarcleanups:
	@echo "cleanup dirs"
	find . -name "*~" -exec rm {} \;
	@echo "change dir attribs"
	find . -type d -exec chmod 755 {} \;
	@echo "change -w flag for group and other"
	chmod -R og-w *
	@echo "change +r flag for group and other"
	chmod -R og+r *

TAR = tar

ifeq ("$(TARGET_OS)","linux")
ifeq ("$(TARGET_CPU)","i686")
TARCPU  := i386
else
ifeq ("$(TARGET_CPU)","alphaev56")
TARCPU  := alpha
else
ifeq ("$(TARGET_CPU)","ia64")
TARCPU  := ia64
else
ifeq ("$(TARGET_CPU)","x86_64")
TARCPU  := x86_64
else
$(error "error: Unknown target CPU $(TARGET_CPU)!")
endif # x86_64
endif # ia64
endif # alphaev56
endif # i686
else
ifeq ("$(TARGET_OS)","osf5.1")
TARCPU  := tru64
TAR = gtar
else
$(error "error: Unknown target OS $(TARGET_OS)!")
endif # osf
endif # linux

tar:	tarcleanups
	$(TAR) --owner=0 --group=0 -C $(BUILDDIR) -czf \
		psmgmt-$(DVER)-`date +%Y%m%d`.$(TARCPU).tar.gz $(DISTPATH)

rpm:	tarcleanups
	$(TOP_SRCDIR)/scripts/rpmbuildpsmgmt $(DVER)

endif
DISTCLEAN+= psmgmt*.tar.gz
DISTCLEAN+= psmgmt*.rpm
DISTCLEAN+= psmgmt*.spec


######################################################
clean:
	$(RM) -r $(BUILDDIR)

realclean distclean: clean
	$(RM) $(DISTCLEAN)

