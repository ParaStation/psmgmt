
CFLAGS += -O2 @CFLAG_WALL@ @CFLAG_G@ @CFLAG_COMPAT@
PSM_OSDIR := @PSM_OSDIR@
CPPFLAGS += -I@top_srcdir@/include -I/usr/local/include -I. @CPPFLAG_MMD@
SRCDIR = @srcdir@
TOP_SRCDIR = @top_srcdir@
YFLAGS = -d
LFLAGS = -i
LEX = flex


VPATH += $(SRCDIR)

LIBDIR := ../lib


ifeq ("@target_os@","linux")
.LIBPATTERNS+= $(LIBDIR)/lib%.a
else
.LIBPATTERNS:=  /usr/shlib/lib%.so $(.LIBPATTERNS) $(LIBDIR)/lib%.a
endif

TOOLS:=psconfig pscounter test_nodes psiadmin psid psld parastation
TOOLS += psilogger psiforwarder mlisten test_config_parsing
# test_nodes

bin:	$(TOOLS)

unlock: unlock.o -lpshal

tracemcp: tracemcp.o -lpvar -lpshal

psconfig: psconfig.o -lpshal -larg -lm

pscounter: pscounter.o -lpshal -lm

test_nodes: test_nodes.o -lpshal -lpsport -larg -lpse -lpsi -lm -lpthread

test_pse: test_pse.o -lpshal -lpsport -larg -lpse -lpsi -lm -lpthread

mlisten: mlisten.o

test_config_parsing: config_parsing.o -lputil -lpscommon

# psiadmin
EXTRACLEAN += lex.admin.c admin.tab.c admin.tab.h
VPATH += $(SRCDIR)/admin
psiadmin: psiadmin.o admin.tab.o lex.admin.o
psiadmin: -lreadline -lhistory -lpsi -l@LIBCURSES@
admin.tab.o: CPPFLAGS += -I$(SRCDIR)/admin
admin.tab.o: admin.tab.c
lex.admin.o: lex.admin.c admin.tab.c admin.tab.h

# psid
VPATH += $(SRCDIR)/daemon $(SRCDIR)/cardconfig
psid: psid.o psidutil.o psidtask.o config_parsing.o cardconfig.o
psid: -lm -lpshal -lputil -lpscommon -lpsi
# -lpsi only needed for forwarder! To be removed soon.

#psld
VPATH += $(SRCDIR)/licdaemon
psld: psld.o license.o config_parsing.o
psld: -lm -lputil -lpscommon

# logger
VPATH += $(SRCDIR)/logger
psiforwarder: psiforwarder.o logmsg.o -lm
psilogger: psilogger.o logmsg.o -lm



parastation: $(TOP_SRCDIR)/scripts/parastation@TRU64FILEADD@
	cp $< $@

# lex and yacc
#: %.tab.c %.scan.y

%.tab.c %.tab.h: %.scan.y
	$(YACC) $(YFLAGS) -b $* $^

# %.tab.h
lex.%.c: %.scan.l %.tab.h
	$(LEX) $(LFLAGS) -P$* $<




# WARNING!!! if DEPEXTENSION from configure is empty, make clean remove all files!!
DEPFILES := $(wildcard *@DEPEXTENSION@) dummy.d

clean:
	$(RM) $(DEPFILES) $(EXTRACLEAN) *.o


-include $(DEPFILES)
