###################################################### -*- Makefile -*- #####
#                  ParaStation
#        Copyright (c) 2002-2003 ParTec AG, Karlsruhe
#        Copyright (c) 2005-2006 Cluster Competence Center GmbH, Munich
#############################################################################
#
# $Id$
#
# @author
#         Jens Hauke <hauke@par-tec.de>
#         Norbert Eicker <eicker@par-tec.de>
#############################################################################

NUMA=@NUMA@
ELANCTRL=@ELANCTRL@

CFLAGS += -O2 @CFLAG_WALL@ @CFLAG_G@ @CFLAG_COMPAT@
CPPFLAGS += -I@top_srcdir@/include -I. @CPPFLAG_MMD@
ifeq ($(NUMA),yes)
CPPFLAGS += -DHAVE_LIBNUMA
endif
LIB_DIRNAME:=@LIB_DIRNAME@
SRCDIR = @srcdir@
TOP_SRCDIR = @top_srcdir@
TARGET_OS := @target_os@

VPATH += $(SRCDIR)

LIBDIR := ../lib

include $(TOP_SRCDIR)/Makefile.version

ifeq ("$(TARGET_OS)","linux")
.LIBPATTERNS+= $(LIBDIR)/lib%.a
else
.LIBPATTERNS:=  /usr/shlib/lib%.so $(.LIBPATTERNS) $(LIBDIR)/lib%.a
endif

TOOLS:= psiadmin psid psilogger mlisten
TOOLS += psmstart mpirun_chp4 psispawn mpirun_chgm gmspawner
TOOLS += mpirun_openib test_pse test_config pssh
TOOLS += psaccounter testacct
ifeq ($(ELANCTRL),yes)
TOOLS += mpirun_elan
endif

TARGETS = $(TOOLS) test_logging

LDFLAGS+=-L../lib -Wl,-rpath,/opt/parastation/$(LIB_DIRNAME)

all bin: $(TOOLS)

$(TOOLS): %: %.o

psiadmin psid mlisten test_pse psmstart mpirun_chp4 mpirun_chgm gmspawner \
	mpirun_openib test_config pssh psaccounter testacct mpirun_elan: \
		LOADLIBES:=$(LOADLIBES) -lpopt

test_pse psmstart mpirun_chp4 mpirun_chgm mpirun_openib pssh psaccounter \
	testacct mpirun_elan: \
		LOADLIBES:=$(LOADLIBES) -lpse -lpsi

mpirun_elan: LOADLIBES:=$(LOADLIBES) -lelanctrl

psiadmin psid test_config: LOADLIBES:=$(LOADLIBES) -lputil

psid psilogger test_config test_logging: LOADLIBES:=$(LOADLIBES) -lpscommon

psiadmin psispawn gmspawner: LOADLIBES:=$(LOADLIBES) -lpsi

gmspawner: LOADLIBES:=$(LOADLIBES) -lpthread

# Version info within 
adminparser.o psidinfo.o mpirun_openib.o mpirun_elan.o: \
	CPPFLAGS += -DVERSION_psmgmt='"$(VERSION_psmgmt)"' \
		-DRELEASE_psmgmt='"$(RELEASE_psmgmt)"'
adminparser.o psidinfo.o mpirun_openib.o mpirun_elan.o: \
	$(TOP_SRCDIR)/Makefile.version

# psiadmin
VPATH += $(SRCDIR)/admin
psiadmin: commands.o adminparser.o
psiadmin: LOADLIBES:=$(LOADLIBES) -lreadline -lhistory -l@LIBCURSES@

adminparser.o: $(TOP_SRCDIR)/Makefile.version

# psid
VPATH += $(SRCDIR)/daemon
psid: psidutil.o psidtask.o psidspawn.o psidforwarder.o
psid: psidsignal.o psidmsgbuf.o psidrdp.o psidclient.o psidcomm.o
psid: psidinfo.o psidoption.o psidpartition.o psidstatus.o psidhw.o
psid: psidaccount.o psidnodes.o
psid: LOADLIBES:=$(LOADLIBES) -lm -lutil -lpslog
ifeq ($(NUMA),yes)
psid: LOADLIBES:=$(LOADLIBES) -lnuma
endif

test_config: psidnodes.o

# logger
VPATH += $(SRCDIR)/logger
psilogger: LOADLIBES:=$(LOADLIBES) -lpslog

parastation: $(TOP_SRCDIR)/scripts/parastation@TRU64FILEADD@
	cp $< $@

# accounter
VPATH += $(SRCDIR)/accounter

# WARNING!!! if DEPEXTENSION from configure is empty, make clean remove all files!!
DEPFILES := $(wildcard *@DEPEXTENSION@) dummy.d

.PHONY: clean distclean

clean:
	$(RM) $(DEPFILES) $(EXTRACLEAN) *.o

distclean: clean
	$(RM) $(TARGETS)

-include $(DEPFILES)
