
CFLAGS += -O2 @CFLAG_WALL@ @CFLAG_G@ @CFLAG_COMPAT@
PSM_OSDIR := @PSM_OSDIR@
CPPFLAGS += -I@top_srcdir@/include -I. @CPPFLAG_MMD@
SRCDIR = @srcdir@
TOP_SRCDIR = @top_srcdir@
TARGET_OS := @target_os@
YFLAGS = -d
LFLAGS = -i
LEX = flex
# "yes" or "no" allowed ("configure --enable-java" or "configure --disable-java") 
JAVA_ENABLED=@JAVA_ENABLED@

VPATH += $(SRCDIR)

LIBDIR := ../lib


ifeq ("$(TARGET_OS)","linux")
.LIBPATTERNS+= $(LIBDIR)/lib%.a
else
.LIBPATTERNS:=  /usr/shlib/lib%.so $(.LIBPATTERNS) $(LIBDIR)/lib%.a
endif

TOOLS:=psconfig pscounter test_nodes psiadmin psid psld psilogger
TOOLS += mlisten psmstart mpirun_chp4 psispawn mpirun_chgm gmspawner
TOOLS += psscan psroute

ifneq ("$(TARGET_OS)","osf5.1")
TOOLS += psmon
endif
ifeq ($(JAVA_ENABLED),yes)
TOOLS += psview
endif

bin:	$(TOOLS)

unlock: unlock.o -lpshal

tracemcp: tracemcp.o -lpvar -lpshal

psconfig: psconfig.o -lpshal -larg -lm

pscounter: pscounter.o -lpshal -lm

test_nodes: test_nodes.o -lpshal -lpsport -larg -lpse -lpsi -lm -lpthread

test_pse: test_pse.o -lpshal -lpsport -larg -lpse -lpsi -lm -lpthread

psmstart: psmstart.o -lpse -lpsi

mpirun_chp4: mpirun_chp4.o -lpse -lpsi -lpopt

psispawn: psispawn.o -lpsi

mpirun_chgm: mpirun_chgm.o -lpse -lpsi -lpopt

gmspawner: gmspawner.o -lpsi -lpopt -lpthread

mlisten: mlisten.o -lpopt

test_config_parsing: -lputil -lpscommon

# psiadmin
EXTRACLEAN += lex.admin.c admin.tab.c admin.tab.h
VPATH += $(SRCDIR)/admin
psiadmin: psiadmin.o admin.tab.o lex.admin.o
psiadmin: -lreadline -lhistory -lpsi -lpopt -l@LIBCURSES@
admin.tab.o: CPPFLAGS += -I$(SRCDIR)/admin
admin.tab.o: admin.tab.c
lex.admin.o: lex.admin.c admin.tab.c admin.tab.h

# psid
VPATH += $(SRCDIR)/daemon
psid: psid.o psidutil.o psidtask.o psidspawn.o psidforwarder.o
psid: psidsignal.o psidmsgbuf.o psidrdp.o psidclient.o psidcomm.o
psid: -lm -lputil -lpscommon -lutil -lpopt -lpslog

#psld
VPATH += $(SRCDIR)/licdaemon
psld: psld.o
psld: -lm -lputil -lpscommon -lpopt

# logger
VPATH += $(SRCDIR)/logger
psilogger: psilogger.o -lpslog -lpscommon -lm

# psscan and psroute
VPATH += $(SRCDIR)/mapper
psroute: genid.o route.o simul.o psroute.o -lpshal -lm -lpopt
psscan: genid.o route.o psscan.o -lpshal -lm -lpopt

# psmon
VPATH += $(SRCDIR)/mon
psmon: psmon.o sock_ext.o edsdict.o edserr.o -lpsi -lpthread -lpopt -lcrypt
#lst.o hosts_dict.o

#psview
psview:
	$(MAKE) -C java/psview



parastation: $(TOP_SRCDIR)/scripts/parastation@TRU64FILEADD@
	cp $< $@

# lex and yacc
#: %.tab.c %.scan.y

%.tab.c %.tab.h: %.scan.y
	$(YACC) $(YFLAGS) -b $* $^

# %.tab.h
lex.%.c: %.scan.l %.tab.h
	$(LEX) $(LFLAGS) -P$* $<




# WARNING!!! if DEPEXTENSION from configure is empty, make clean remove all files!!
DEPFILES := $(wildcard *@DEPEXTENSION@) dummy.d

clean:
	$(RM) $(DEPFILES) $(EXTRACLEAN) *.o


-include $(DEPFILES)
