###################################################### -*- Makefile -*- #####
#                  ParaStation
#        Copyright (c) 2002-2003 ParTec AG Karlsruhe
#        All rights reserved.
#############################################################################
#
# $Id: Makefile.in,v 1.38 2003/09/12 15:48:34 eicker Exp $
#
# @author
#         Jens Hauke <hauke@par-tec.de>
#         Norbert Eicker <eicker@par-tec.de>
#############################################################################

CFLAGS += -O2 @CFLAG_WALL@ @CFLAG_G@ @CFLAG_COMPAT@
CPPFLAGS += -I@top_srcdir@/include -I. @CPPFLAG_MMD@
SRCDIR = @srcdir@
TOP_SRCDIR = @top_srcdir@
TARGET_OS := @target_os@
YFLAGS = -d
LFLAGS = -i
LEX = flex

VPATH += $(SRCDIR)

LIBDIR := ../lib


ifeq ("$(TARGET_OS)","linux")
.LIBPATTERNS+= $(LIBDIR)/lib%.a
else
.LIBPATTERNS:=  /usr/shlib/lib%.so $(.LIBPATTERNS) $(LIBDIR)/lib%.a
endif

TOOLS:= psiadmin psid psld psilogger mlisten
TOOLS += psmstart mpirun_chp4 psispawn mpirun_chgm gmspawner
# TOOLS += test_nodes

TARGETS = $(TOOLS) test_pse test_config_parsing

all bin: $(TOOLS)

test_nodes: test_nodes.o -lpshal -lpsport -lpopt -lpse -lpsi -lm -lpthread

test_pse: test_pse.o -lpopt -lpse -lpsi

psmstart: psmstart.o -lpse -lpsi -lpopt

mpirun_chp4: mpirun_chp4.o -lpse -lpsi -lpopt

psispawn: psispawn.o -lpsi

mpirun_chgm: mpirun_chgm.o -lpse -lpsi -lpopt

gmspawner: gmspawner.o -lpsi -lpopt -lpthread

mlisten: mlisten.o -lpopt

test_config_parsing: -lputil -lpscommon

# psiadmin
VPATH += $(SRCDIR)/admin
psiadmin: psiadmin.o commands.o adminparser.o
psiadmin: -lreadline -lhistory -lpsi -lpopt -l@LIBCURSES@ -lputil

# psid
VPATH += $(SRCDIR)/daemon
psid: psid.o psidutil.o psidtask.o psidspawn.o psidforwarder.o
psid: psidsignal.o psidmsgbuf.o psidrdp.o psidclient.o psidcomm.o
psid: psidinfo.o psidoption.o psidpartition.o
psid: -lm -lputil -lpscommon -lutil -lpopt -lpslog

#psld
VPATH += $(SRCDIR)/licdaemon
psld: psld.o
psld: -lm -lputil -lpscommon -lpopt

# logger
VPATH += $(SRCDIR)/logger
psilogger: psilogger.o -lpslog -lpscommon -lm

parastation: $(TOP_SRCDIR)/scripts/parastation@TRU64FILEADD@
	cp $< $@

# lex and yacc
#: %.tab.c %.scan.y

%.tab.c %.tab.h: %.scan.y
	$(YACC) $(YFLAGS) -b $* $^

# %.tab.h
lex.%.c: %.scan.l %.tab.h
	$(LEX) $(LFLAGS) -P$* $<




# WARNING!!! if DEPEXTENSION from configure is empty, make clean remove all files!!
DEPFILES := $(wildcard *@DEPEXTENSION@) dummy.d

clean:
	$(RM) $(DEPFILES) $(EXTRACLEAN) *.o

realclean: clean
	$(RM) $(TARGETS)

-include $(DEPFILES)
