###################################################### -*- Makefile -*- #####
#                  ParaStation
#        Copyright (c) 2003 ParTec AG, Karlsruhe
#        Copyright (c) 2005 Cluster Competence Center GmbH, Munich
#############################################################################
#
# $Id$
#
# @author
#         Jens Hauke <hauke@par-tec.de>
#############################################################################

TOP_SRCDIR := @top_srcdir@
TOP_BUILDDIR := @top_builddir@

INSTALL = @INSTALL@
INSTFLAGS_NOEXEC = -m 644
LIB_DIRNAME:=@LIB_DIRNAME@

#############################################################################
#s.o. clean:
DISTPATH := opt/parastation

INCDIR := $(DISTPATH)/include
BINDIR := $(DISTPATH)/bin
LIBDIR := $(DISTPATH)/$(LIB_DIRNAME)

ACCLOGDIR:= var/account

INCLUDES += pse.h
INCLUDES += psprotocol.h psnodes.h pstask.h pspartition.h pscommon.h
INCLUDES += psiinfo.h psispawn.h psienv.h psi.h logging.h

BINS += gmspawner mlisten mpirun_chgm mpirun_chp4 mpirun_openib psiadmin
BINS += psid psilogger psispawn psmstart test_config test_pse pssh psaccounter

LIBS += libpse.a libpse.so libpsi.a libpsi.so

MISC += VERSION.psmgmt ChangeLog.psmgmt INSTALL LICENSE
MISC += bin/psh
MISC += config/PSM_INSTALL config/parastation.conf.tmpl config/ps_gm config/ps_acc
MISC += scripts/ps_gmcounters bin/psaccview

######################################################
MISCEXP := $(patsubst %,$(DISTPATH)/%, $(MISC))
MISCEXP += $(RPM_BUILD_ROOT)/etc/profile.d/psmgmt.csh
MISCEXP += $(RPM_BUILD_ROOT)/etc/profile.d/psmgmt.sh
MISCEXP += $(RPM_BUILD_ROOT)/etc/init.d/parastation
MISCEXP += $(ACCLOGDIR)

all: tar

install:  libs bins includes $(MISCEXP)


include $(TOP_SRCDIR)/Makefile.version
include $(TOP_SRCDIR)/dist/Makefile.sources

DISTNAME=psmgmt-$(VERSION_psmgmt)-$(RELEASE_psmgmt)

$(DISTNAME)/configure: $(TOP_SRCDIR)/configure
	$(INSTALL) -D $< $@

$(DISTNAME)/scripts/rpm_noreq: $(TOP_SRCDIR)/scripts/rpm_noreq
	$(INSTALL) -D $< $@

$(DISTNAME)/%: $(TOP_SRCDIR)/%
	$(INSTALL) $(INSTFLAGS_NOEXEC) -D $< $@

$(DISTNAME)/$(DISTNAME).spec: $(TOP_SRCDIR)/dist/psmgmt.spec.in $(DISTNAME)
	sed ":t \
		s,@_CONFIGARGS@,$(CONFIGARGS),;t t \
		s,@VERSION_psmgmt@,$(VERSION_psmgmt),;t t \
		s,@RELEASE_psmgmt@,$(RELEASE_psmgmt),;t t" $< > $@

$(DISTNAME).tar.gz: $(patsubst %,$(DISTNAME)/%,$(SOURCE_FILES)) \
    $(patsubst %,$(DISTNAME)/%,$(SCRIPT_FILES)) $(DISTNAME)/$(DISTNAME).spec
	tar --owner=0 --group=0 -czf $@ $(DISTNAME)


.PHONY: tar
tar: $(DISTNAME).tar.gz

.PHONY: srpm
srpm: $(DISTNAME).src.rpm

$(DISTNAME).src.rpm: $(DISTNAME).tar.gz
	rpmbuild --define="_srcrpmdir $$PWD" -ts $<

.PHONY: rpm
rpm: $(DISTNAME).tar.gz srpm
	rpmbuild --clean --target @target_cpu@-@target_vendor@-@target_os@ \
		--define="_rpmdir $$PWD" -tb $<

#
# building stripped libs
#
$(LIBDIR)/%: $(TOP_BUILDDIR)/lib/%
	$(INSTALL) -D $< $@

libs: $(patsubst %,$(LIBDIR)/%,$(LIBS))

#
# building stripped bins
#
$(BINDIR)/%: $(TOP_BUILDDIR)/bin/%
	$(INSTALL) -D -s $< $@

bins: $(patsubst %,$(BINDIR)/%,$(BINS))

#
# copy includes
#
$(INCDIR)/%: $(TOP_SRCDIR)/include/%
	$(INSTALL) $(INSTFLAGS_NOEXEC) -D $< $@

includes: $(patsubst %,$(INCDIR)/%,$(INCLUDES))

#
# Misc files
#
.PHONY: $(DISTPATH)/VERSION.psmgmt
$(DISTPATH)/VERSION.psmgmt:
	echo "ParaStation Management $(VERSION_psmgmt)-$(RELEASE_psmgmt) ($(shell date))" > $@

$(DISTPATH)/ChangeLog.psmgmt: $(TOP_SRCDIR)/dist/ChangeLog
	$(INSTALL) $(INSTFLAGS_NOEXEC) -D $< $@

$(DISTPATH)/INSTALL: $(TOP_SRCDIR)/doc/INSTALL
	$(INSTALL) $(INSTFLAGS_NOEXEC) -D $< $@

$(DISTPATH)/LICENSE: $(TOP_SRCDIR)/LICENSE
	$(INSTALL) $(INSTFLAGS_NOEXEC) -D $< $@

$(DISTPATH)/bin/psh: $(TOP_SRCDIR)/scripts/psh
	$(INSTALL) -D $< $@

$(DISTPATH)/config/PSM_INSTALL: $(TOP_SRCDIR)/scripts/PSM_INSTALL
	$(INSTALL) -D $< $@

$(DISTPATH)/config/parastation.conf.tmpl: $(TOP_SRCDIR)/doc/parastation.conf
	$(INSTALL) $(INSTFLAGS_NOEXEC) -D $< $@

$(DISTPATH)/config/ps_gm: $(TOP_SRCDIR)/scripts/ps_gm
	$(INSTALL) -D $< $@

$(DISTPATH)/config/ps_acc: $(TOP_SRCDIR)/scripts/ps_acc
	$(INSTALL) -D $< $@

$(DISTPATH)/scripts/ps_gmcounters: $(TOP_SRCDIR)/scripts/ps_gmcounters
	$(INSTALL) -D $< $@

$(DISTPATH)/bin/psaccview: $(TOP_SRCDIR)/scripts/psaccview
	$(INSTALL) -D $< $@

$(RPM_BUILD_ROOT)/etc/profile.d/psmgmt.%: $(TOP_SRCDIR)/scripts/psmgmt.%
	$(INSTALL) -D $< $@

$(RPM_BUILD_ROOT)/etc/init.d/parastation: $(TOP_SRCDIR)/scripts/parastation.init.d
	$(INSTALL) -D $< $@

$(ACCLOGDIR):
	$(INSTALL) -d $(RPM_BUILD_ROOT)/$@
	$(INSTALL) -m 750 -d $(RPM_BUILD_ROOT)/$@

DISTCLEAN+= psmgmt*.tar.gz
DISTCLEAN+= psmgmt*.rpm
DISTCLEAN+= psmgmt*.spec


.PHONY: clean distclean

clean:
	$(RM) -r $(DISTNAME)

distclean: clean
	$(RM) $(DISTCLEAN)
