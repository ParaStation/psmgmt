###################################################### -*- Makefile -*- #####
#                  ParaStation
#        Copyright (c) 2002-2003 ParTec AG Karlsruhe
#        All rights reserved.
#############################################################################
#
# $Id: Makefile.in,v 1.6 2003/10/22 09:09:33 eicker Exp $
#
# @author
#         Jens Hauke <hauke@par-tec.de>
#         Norbert Eicker <eicker@par-tec.de>
#############################################################################

TOP_SRCDIR := @top_srcdir@
TOP_BUILDDIR := ..

#s.o. clean:
BUILDDIR := build
DISTPATH := opt/parastation
DISTDIR := $(BUILDDIR)/$(DISTPATH)

DOCDIR := $(DISTDIR)/doc
DOCS = html/index.html html/adminguide html/userguide html/images html/api
DOCS += pdf/adminguide.pdf pdf/userguide.pdf

MANDIR := $(DISTDIR)/man
MANS := man1 man3 man5 man7 man8

EXAMPLEDIR := $(DOCDIR)/examples
EXAMPLES := Makefile native.c

MISCDIR := $(DOCDIR)/html $(DOCDIR)/pdf

DIRS = $(DOCDIR) $(MANDIR) $(MISCDIR) $(EXAMPLEDIR)

######################################################
all: dirs docu tar rpm

dist_doc: all

# Creating directories
$(DIRS):
	mkdir -p $@

dirs: $(DIRS)

#
# Documentation
#
docu: docs manuals examples

docs: $(DOCDIR) $(patsubst %,$(DOCDIR)/%,$(DOCS))

$(DOCDIR)/%: $(TOP_BUILDDIR)/docu/%
	cp -rp $< $@

manuals: $(MANDIR) $(patsubst %,$(MANDIR)/%,$(MANS))

$(MANDIR)/%: $(TOP_BUILDDIR)/docu/man/%
	cp -rp $< $@

examples: $(EXAMPLEDIR) $(patsubst %,$(EXAMPLEDIR)/%,$(EXAMPLES))

$(EXAMPLEDIR)/%: $(TOP_SRCDIR)/examples/%
	cp -rp $< $@

######################################################
# Create tar file

ifeq ($(DVER),)
tar rpm:
	@echo Use DVER=x.x.x to create $@ file.
else

tarcleanups:
	@echo "cleanup dirs"
	find . -name "*~" -exec rm {} \;
	@echo "change dir attribs"
	find . -type d -exec chmod 755 {} \;
	@echo "change -w flag for group and other"
	chmod -R og-w *
	@echo "change +r flag for group and other"
	chmod -R og+r *

tar:	tarcleanups
	tar --owner=0 --group=0 -C $(BUILDDIR) -czf \
		psdoc-$(DVER)-`date +%Y%m%d`.tar.gz $(DISTPATH)

rpm:	tarcleanups
	$(TOP_SRCDIR)/scripts/rpmbuilddoc $(DVER)

endif
DISTCLEAN+= psdoc*.tar.gz
DISTCLEAN+= psdoc*.rpm
DISTCLEAN+= psdoc*.spec


######################################################
clean:
	$(RM) -r $(BUILDDIR)

realclean distclean: clean
	$(RM) $(DISTCLEAN)
