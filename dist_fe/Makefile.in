###################################################### -*- Makefile -*- #####
#                  ParaStation
#        Copyright (c) 2002-2003 ParTec AG Karlsruhe
#        All rights reserved.
#############################################################################
#
# $Id: Makefile.in,v 1.17 2003/07/18 14:16:14 eicker Exp $
#
# @author
#         Jens Hauke <hauke@par-tec.de>
#         Norbert Eicker <eicker@par-tec.de>
#############################################################################

TOP_SRCDIR := @top_srcdir@
TOP_BUILDDIR := ..

TARGET_OS := @target_os@
TARGET_CPU := @target_cpu@

#s.o. clean:
BUILDDIR := build
DISTPATH := opt/parastation
DISTDIR := $(BUILDDIR)/$(DISTPATH)

INCLUDES += psport4.h
INCDIR := $(DISTDIR)/include

LIBS += libpsport4.a
ifeq ("$(TARGET_OS)","linux")
LIBS += libpsport4.so
endif
LIBDIR := $(DISTDIR)/lib

CONFIGDIR := $(DISTDIR)/config

MISC += config/ps_ethernet

MISC += VERSION.psfe

DIRS += $(LIBDIR) $(INCDIR) $(CONFIGDIR)

######################################################
MISCEXP := $(patsubst %,$(DISTDIR)/%, $(MISC))

all: dirs libs includes $(MISCEXP) tar rpm

dist:	all

# Creating directories
$(DIRS):
	mkdir -p $@

dirs: $(DIRS)

#
# building stripped libs
#
ifeq ("$(TARGET_OS)","linux")
$(LIBDIR)/%: $(TOP_BUILDDIR)/lib/%
	cp $< $@
	strip -g $@
endif
ifeq ("$(TARGET_OS)","osf5.1")
$(LIBDIR)/%: $(TOP_BUILDDIR)/lib/%
	cp $< $@
endif

libs: $(LIBDIR) $(patsubst %,$(LIBDIR)/%,$(LIBS))

#
# building stripped bins
#
$(BINDIR)/%: $(TOP_BUILDDIR)/bin/%
	cp $< $@
	strip $@
#	strip $< -o $@

bins: $(BINDIR) $(patsubst %,$(BINDIR)/%,$(BINS))

#
# copy includes
#
$(INCDIR)/%: $(TOP_SRCDIR)/include/%
	cp $< $@

includes: $(INCDIR) $(patsubst %,$(INCDIR)/%,$(INCLUDES))

#
# Misc files
#

$(DISTDIR)/config/ps_ethernet: $(TOP_SRCDIR)/scripts/ps_ethernet
	cp $< $@

.PHONY: $(DISTDIR)/VERSION.psfe
$(DISTDIR)/VERSION.psfe:
	echo "ParaStation FE $(DVER) ($(shell date))" > $@

######################################################
# Create tar file

ifeq ($(DVER),)
tar rpm:
	@echo Use DVER=x.x.x to create $@ file.
else

tarcleanups:
	@echo "cleanup dirs"
	find . -name "*~" -exec rm {} \;
	@echo "change dir attribs"
	find . -type d -exec chmod 755 {} \;
	@echo "change -w flag for group and other"
	chmod -R og-w *
	@echo "change +r flag for group and other"
	chmod -R og+r *

TAR = tar

ifeq ("$(TARGET_OS)","linux")
ifeq ("$(TARGET_CPU)","i686")
TARCPU  := i386
endif
ifeq ("$(TARGET_CPU)","alphaev56")
TARCPU  := alpha
endif
else
ifeq ("$(TARGET_OS)","osf5.1")
TARCPU  := tru64
TAR = gtar
else
tar rpm:
	@echo Unknown target OS $(TARGET_OS).
endif
endif

tar:	tarcleanups
	$(TAR) --owner=0 --group=0 -C $(BUILDDIR) -czf \
		psfe-$(DVER)-`date +%Y%m%d`.$(TARCPU).tar.gz $(DISTPATH)

rpm:	tarcleanups
	$(TOP_SRCDIR)/scripts/rpmbuildpsfe $(DVER)

endif
DISTCLEAN+= psfe*.tar.gz
DISTCLEAN+= psfe*.rpm
DISTCLEAN+= psfe*.spec


######################################################
clean:
	$(RM) -r $(BUILDDIR)

realclean distclean: clean
	$(RM) $(DISTCLEAN)
