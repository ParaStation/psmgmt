###################################################### -*- Makefile -*- #####
#                  ParaStation3
#        Copyright (c) 2002 ParTec AG Karlsruhe
#        All rights reserved.
#############################################################################
#
# $Id: Makefile.in,v 1.8 2002/10/01 12:42:50 hauke Exp $
#
# @author
#         Jens Hauke <hauke@par-tec.de>
#############################################################################

TOP_SRCDIR := @top_srcdir@
TOP_BUILDDIR := ..

TARGET_OS := @target_os@
TARGET_CPU := @target_cpu@

# "yes" or "no" allowed ("configure --enable-java" or "configure --disable-java") 
JAVA_ENABLED=@JAVA_ENABLED@
PSMON_ENABLED=@PSMON_ENABLED@

#s.o. clean:
DISTPATH := opt/parastation

INCLUDES += psport4.h pshwtypes.h pse.h
INCDIR := $(DISTPATH)/include

BINS += psiadmin psid psld
BINS += psiforwarder psilogger mlisten psmstart
ifeq ($(PSMON_ENABLED),yes)
BINS += psmon
endif
BINDIR := $(DISTPATH)/bin

ifeq ($(JAVA_ENABLED),yes)
BINS += java/PSView.jar
endif

LIBS += libpsport4.a libpsi.a libpse.a
ifeq ("$(TARGET_OS)","linux")
LIBS += libpsport4.so libpsi.so libpse.so
endif
LIBDIR := $(DISTPATH)/lib

CONFIGDIR := $(DISTPATH)/config

MISC += config/parastation.conf.tmpl VERSION INSTALL config/PSM_INSTALL
.PHONY: VERSION

MISCDIR :=

DIRS += $(BINDIR) $(LIBDIR) $(INCDIR) $(MISCDIR) $(CONFIGDIR)

######################################################
MISCEXP := $(patsubst %,$(DISTPATH)/%, $(MISC))

all: dirs libs bins includes $(MISCEXP) tar rpm

dist:	all

# Creating directories
$(DIRS):
	mkdir -p $@

dirs: $(DIRS)

#
# building striped libs
#
ifeq ("$(TARGET_OS)","linux")
$(LIBDIR)/%: $(TOP_BUILDDIR)/lib/%
	cp $< $@
	strip -g $<
endif
ifeq ("$(TARGET_OS)","osf5.1")
$(LIBDIR)/%: $(TOP_BUILDDIR)/lib/%
	cp $< $@
endif

libs: $(LIBDIR) $(patsubst %,$(LIBDIR)/%,$(LIBS))

#
# building striped bins
#
$(BINDIR)/%: $(TOP_BUILDDIR)/bin/%
	cp $< $@
	strip $@
#	strip $< -o $@

bins: $(BINDIR) $(patsubst %,$(BINDIR)/%,$(BINS))

# From java build tree
$(BINDIR)/java/PSView.jar: $(TOP_BUILDDIR)/bin/java/psview/PSView.jar
	mkdir -p `dirname $@`
	cp $< $@

#
# copy includes
#
$(INCDIR)/%: $(TOP_SRCDIR)/include/%
	cp $< $@

includes: $(INCDIR) $(patsubst %,$(INCDIR)/%,$(INCLUDES))

#
# Misc files
#
$(DISTPATH)/config/parastation.conf.tmpl: $(TOP_SRCDIR)/doc/parastation.conf
	cp $< $@

$(DISTPATH)/INSTALL: $(TOP_SRCDIR)/doc/INSTALL
	cp $< $@

$(DISTPATH)/bin/parastation: $(TOP_SRCDIR)/scripts/parastation@TRU64FILEADD@
	cp $< $@

$(DISTPATH)/config/PSM_INSTALL: $(TOP_SRCDIR)/scripts/PSM_INSTALL
	cp $< $@

$(DISTPATH)/config/sysconfigtab: $(TOP_SRCDIR)/kern/OSF1/sysconfigtab
	cp $< $@

$(DISTPATH)/config/psm_makedev: $(TOP_SRCDIR)/scripts/psm_makedev
	cp $< $@

$(DISTPATH)/VERSION:
	echo "ParaStation FE $(DVER) ($(shell date))" > $@

######################################################
# Create tar file

ifeq ($(DVER),)
tar rpm:
	@echo Use DVER=x.x.x to create $@ file.
else

tarcleanups:
	@echo "cleanup dirs"
	find . -name "*~" -exec rm {} \;
	@echo "change dir attribs"
	find . -type d -exec chmod 755 {} \;
	@echo "change -w flag for group and other"
	chmod -R og-w *
	@echo "change +r flag for group and other"
	chmod -R og+r *

ifeq ("$(TARGET_OS)","linux")
ifeq ("$(TARGET_CPU)","i686")
TARCPU  := i386
endif
ifeq ("$(TARGET_CPU)","alphaev56")
TARCPU  := alpha
endif

tar:	tarcleanups
	tar --owner=0 --group=0 -czf psfe_$(TARCPU)-$(DVER).tgz $(DISTPATH)

endif
ifeq ("$(TARGET_OS)","osf5.1")
TARCPU  := tru64

tar:	tarcleanups
	gtar --owner=0 --group=0 -czf psfe_$(TARCPU)-$(DVER).tar.gz $(DISTPATH)

endif

rpm:	tarcleanups
	$(TOP_SRCDIR)/scripts/rpmbuildpsfe $(DVER)

endif
DISTCLEAN+= psfe*.tar.gz
DISTCLEAN+= psfe*.tgz
DISTCLEAN+= psfe*.rpm
DISTCLEAN+= psfe*.spec


######################################################
clean:
	rm -rf opt/parastation

distclean: clean
	$(RM) $(DISTCLEAN)
